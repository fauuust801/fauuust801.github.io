<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æ¤è¢«é‡è¦å€¼åŒæ–¹æ³•è®¡ç®—å·¥å…·</title>
<style>
  :root{--bg:#ffffff;--muted:#6b7280;--accent:#1f6f4b}
  body{font-family: "Microsoft YaHei", Arial, sans-serif; background:#f6f8f9; color:#0b2540; margin:18px; max-width:1100px}
  header{display:flex;align-items:center;gap:12px}
  h1{font-size:20px;margin:0;color:var(--accent)}
  .mode-switch{margin-top:12px}
  .mode-switch button{padding:8px 12px;margin-right:8px;border-radius:6px;border:none;background:#7f8c8a;color:#fff;cursor:pointer}
  .mode-switch button.active{background:var(--accent)}
  .card{background:#fff;border:1px solid #e6eef7;border-radius:8px;padding:12px;margin-top:12px}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
  th,td{border:1px solid #e6eef7;padding:6px;text-align:center}
  th{background:#f1f6fb}
  input[type="number"], input[type="text"]{width:100%;box-sizing:border-box;padding:6px;border-radius:4px;border:1px solid #d1dbe6}
  .row-actions{display:flex;gap:8px;align-items:center}
  button.action{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
  button.secondary{background:#6b7280;color:#fff}
  .muted{color:var(--muted);font-size:13px}
  .formula{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,monospace;background:#fbfbff;padding:8px;border-radius:6px;border:1px dashed #e0e7ef;margin-top:6px}
  .result-block{margin-top:10px}
  .history{margin-top:12px}
  .card-record{border-top:1px dashed #e6eef7;padding:8px 0}
  footer{margin-top:24px;font-size:12px;color:#6b7280;text-align:center}
  .flex{display:flex;gap:8px;align-items:center}
  .right{margin-left:auto}
  .small{font-size:12px;color:#61707a}
</style>
</head>
<body>

<header>
  <div>
    <h1>æ¤è¢«é‡è¦å€¼åŒæ–¹æ³•è®¡ç®—å·¥å…·</h1>
    <div class="small muted">æ ·æ–¹æ³• & ä¸­ç‚¹æ–¹è§’æ³• â€” æ˜¾ç¤ºå…¬å¼ä¸ä»£å…¥è¿‡ç¨‹ã€‚ç»“æœä¿ç•™ä¸¤ä½å°æ•°ï¼Œæ”¯æŒå¤šæ¬¡è®°å½•ä¸ CSV å¯¼å‡ºã€‚</div>
  </div>
</header>

<div class="mode-switch">
  <button id="btnSample" class="active" onclick="switchMode('sample')">æ ·æ–¹æ³•</button>
  <button id="btnPoint" onclick="switchMode('point')">ä¸­ç‚¹æ–¹è§’æ³•</button>
</div>

<!-- æ ·æ–¹æ³• -->
<div id="panel-sample" class="card" style="display:block">
  <strong>æ ·æ–¹æ³•ï¼ˆæ ·åœ°é¢ç§¯ï¼š600 mÂ²ï¼›å°æ ·æ–¹æ€»æ•°ï¼š4ï¼›è°ƒæŸ¥æœ€å°å•ä½ï¼š37.5 mÂ²ï¼‰</strong>
  <div class="muted small">è¾“å…¥å¤šè¡Œç‰©ç§æ•°æ®ï¼Œç‚¹å‡»â€œè®¡ç®—é‡è¦å€¼â€ã€‚ç³»ç»Ÿå°†å¯¹å½“å‰è¡¨æ‰€æœ‰ç‰©ç§ä¸€èµ·è¿›è¡Œæ±‡æ€»è®¡ç®—ï¼Œå¹¶æ˜¾ç¤ºæ¯ä¸ªç‰©ç§çš„å…¬å¼ä¸ä»£å…¥è¿‡ç¨‹ã€‚</div>

  <table id="sampleTable" aria-label="æ ·æ–¹æ³•è¾“å…¥è¡¨">
    <thead>
      <tr><th>ç§å</th><th>ä¸ªä½“æ•°</th><th>æ ‘é«˜ (m)</th><th>èƒ¸å¾„ DBH (cm)</th><th>å† å¹… E-W (m)</th><th>å† å¹… N-S (m)</th><th>å‡ºç°å°æ ·æ–¹æ•° (0-4)</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" value="ç‰©ç§A"></td>
        <td><input type="number" value="10" min="0"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" step="0.01" value="15"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" value="3" min="0" max="4"></td>
        <td><button class="secondary" onclick="delRow(this,'sample')">åˆ é™¤</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ç‰©ç§B"></td>
        <td><input type="number" value="5" min="0"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" step="0.01" value="12"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" value="2" min="0" max="4"></td>
        <td><button class="secondary" onclick="delRow(this,'sample')">åˆ é™¤</button></td>
      </tr>
    </tbody>
  </table>

  <div class="row-actions" style="margin-top:8px">
    <button class="action" onclick="addRow('sample')">ï¼‹ æ·»åŠ ç‰©ç§</button>
    <button class="action" onclick="computeSample()">è®¡ç®—é‡è¦å€¼</button>
    <div class="right muted">æ³¨ï¼šè‹¥ä½ æœ‰èƒ¸å›´(C)ï¼Œè¯·å…ˆåœ¨èƒ¸å¾„æ æ¢ç®—ï¼ˆDBH = C / Ï€ï¼‰åè¾“å…¥</div>
  </div>

  <div id="sampleResult" class="result-block"></div>
</div>

<!-- ä¸­ç‚¹æ–¹è§’æ³• -->
<div id="panel-point" class="card" style="display:none">
  <strong>ä¸­ç‚¹æ–¹è§’æ³•ï¼ˆæ²¿æ ·çº¿è®¾ç½®æ ·ç‚¹ï¼Œæ¯æ ·ç‚¹ 4 è±¡é™ï¼Œè°ƒæŸ¥æ¯è±¡é™æœ€è¿‘ä¸ªä½“ï¼‰</strong>
  <div class="muted small">è¾“å…¥å¤šè¡Œç‰©ç§æ•°æ®ï¼Œéœ€åœ¨ä¸Šæ–¹è¾“å…¥æ ·ç‚¹æ€»æ•°ï¼›ç³»ç»Ÿå¯¹å½“å‰è¡¨æ‰€æœ‰ç‰©ç§ä¸€èµ·è®¡ç®—ç›¸å¯¹å¯†åº¦ã€é¢‘åº¦ã€ç›¸å¯¹é¢‘åº¦ã€ç›¸å¯¹æ˜¾è‘—åº¦ä¸é‡è¦å€¼ã€‚</div>

  <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
    <label>æ ·ç‚¹æ€»æ•°ï¼š<input id="pointTotal" type="number" value="20" min="1" style="width:100px"></label>
    <div class="muted small">ï¼ˆä¾‹å¦‚ï¼š20ï¼‰</div>
  </div>

  <table id="pointTable" aria-label="ä¸­ç‚¹æ³•è¾“å…¥è¡¨">
    <thead>
      <tr><th>ç§å</th><th>ä¸ªä½“æ•°</th><th>æ ‘é«˜ (m)</th><th>èƒ¸å¾„ DBH (cm)</th><th>å† å¹… E-W (m)</th><th>å† å¹… N-S (m)</th><th>å‡ºç°æ ·ç‚¹æ•°</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="text" value="ç‰©ç§A"></td>
        <td><input type="number" value="15" min="0"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" step="0.01" value="18"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" value="8" min="0"></td>
        <td><button class="secondary" onclick="delRow(this,'point')">åˆ é™¤</button></td>
      </tr>
      <tr>
        <td><input type="text" value="ç‰©ç§B"></td>
        <td><input type="number" value="7" min="0"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" step="0.01" value="10"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" step="0.01"></td>
        <td><input type="number" value="5" min="0"></td>
        <td><button class="secondary" onclick="delRow(this,'point')">åˆ é™¤</button></td>
      </tr>
    </tbody>
  </table>

  <div class="row-actions" style="margin-top:8px">
    <button class="action" onclick="addRow('point')">ï¼‹ æ·»åŠ ç‰©ç§</button>
    <button class="action" onclick="computePoint()">è®¡ç®—é‡è¦å€¼</button>
    <div class="right muted">æ³¨æ„ï¼šç›¸å¯¹å¯†åº¦æŒ‰ç‰©ç§æ€»ä¸ªä½“æ•°å æ¯”è®¡ç®—ï¼›é¢‘åº¦æŒ‰â€œå‡ºç°æ ·ç‚¹æ•°/æ ·ç‚¹æ€»æ•°â€ã€‚</div>
  </div>

  <div id="pointResult" class="result-block"></div>
</div>

<!-- è®°å½•åŒºä¸å¯¼å‡º -->
<div class="card history">
  <div style="display:flex;align-items:center">
    <strong>ğŸ“˜ æ•°æ®è®°å½•åŒº</strong>
    <div class="right">
      <button class="secondary" onclick="clearRecords()">æ¸…ç©ºè®°å½•</button>
      <button class="action" onclick="exportAllCSV()">å¯¼å‡ºå…¨éƒ¨è®°å½• (CSV)</button>
    </div>
  </div>
  <div id="historyArea" style="margin-top:8px"></div>
</div>

<footer>Â© 2025 faust | æ¤è¢«é‡è¦å€¼åŒæ–¹æ³•è®¡ç®—å·¥å…·</footer>

<script>
/* ---- å·¥å…·å‡½æ•° ---- */
function round2(x){ return Math.round((x+1e-12)*100)/100; } // ä¸¤ä½å°æ•°
function fmt(x){ return round2(x).toFixed(2); }
function el(tag, html){ const e=document.createElement(tag); e.innerHTML=html; return e; }

/* ---- æ¨¡å¼åˆ‡æ¢ ---- */
function switchMode(mode){
  document.getElementById('panel-sample').style.display = mode==='sample' ? 'block' : 'none';
  document.getElementById('panel-point').style.display = mode==='point' ? 'block' : 'none';
  document.getElementById('btnSample').classList.toggle('active', mode==='sample');
  document.getElementById('btnPoint').classList.toggle('active', mode==='point');
}

/* ---- è¡¨æ ¼è¡Œæ“ä½œ ---- */
function addRow(kind){
  const table = kind==='sample' ? document.getElementById('sampleTable') : document.getElementById('pointTable');
  const tr = table.tBodies[0].insertRow();
  tr.innerHTML = `<td><input type="text"></td>
    <td><input type="number" value="0" min="0"></td>
    <td><input type="number" step="0.01"></td>
    <td><input type="number" step="0.01"></td>
    <td><input type="number" step="0.01"></td>
    <td><input type="number" step="0.01"></td>
    <td><input type="number" value="0" min="0"></td>
    <td><button class="secondary" onclick="delRow(this,'${kind}')">åˆ é™¤</button></td>`;
}
function delRow(btn, kind){
  const tr = btn.closest('tr');
  tr.parentNode.removeChild(tr);
}

/* ---- è®°å½•ç®¡ç† ---- */
let records = []; // æ¯ä¸ªè®°å½•ä¸ºå¯¹è±¡ {method, time, detailHTML, csvRow...}
function appendRecord(obj){
  records.push(obj);
  renderHistory();
}
function renderHistory(){
  const area = document.getElementById('historyArea');
  area.innerHTML = '';
  records.forEach((r,i)=>{
    const card = document.createElement('div');
    card.className='card-record';
    card.innerHTML = `<div style="display:flex;align-items:center;gap:8px">
      <strong>#${i+1} ${r.method}</strong>
      <div class="muted small">${r.time}</div>
      <div class="right"><button class="secondary" onclick="removeRecord(${i})">åˆ é™¤</button></div>
    </div>
    <div style="margin-top:8px">${r.detailHTML}</div>`;
    area.appendChild(card);
  });
}
function removeRecord(i){ records.splice(i,1); renderHistory(); }
function clearRecords(){ if(!confirm('æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ')) return; records=[]; renderHistory(); }

/* ---- CSV å¯¼å‡º ---- */
function exportAllCSV(){
  if(records.length===0){ alert('æ— è®°å½•å¯å¯¼å‡º'); return; }
  // CSV header
  const header = ['æ–¹æ³•','æ—¶é—´','ç§å','ç›¸å¯¹å¯†åº¦(%)','ç›¸å¯¹æ˜¾è‘—åº¦(%)','ç›¸å¯¹é¢‘åº¦(%)','é‡è¦å€¼'];
  const lines = [header.join(',')];
  records.forEach(r=>{
    // r.csvRows can be an array for multiple species per calculation; each row: [method,time,name,relD,relS,relF,IV]
    r.csvRows.forEach(row => lines.push(row.map(v=>''+v).join(',')));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'æ¤è¢«é‡è¦å€¼è®°å½•.csv';
  a.click();
}

/* ---- è®¡ç®—ï¼šæ ·æ–¹æ³• ----
   å…¬å¼ï¼ˆä¸ºæ¯ä¸ªç‰©ç§ï¼‰ï¼š
   å¯†åº¦ = n / 600
   ç›¸å¯¹å¯†åº¦(%) = (è¯¥ç§å¯†åº¦ / æ‰€æœ‰ç§å¯†åº¦ä¹‹å’Œ) Ã—100%
   å•æ ªèƒ¸é«˜æ–­é¢ç§¯ = Ï€ Ã— (DBH/2 /100)^2  (m^2)
   èƒ¸é«˜æ–­é¢ç§¯å’Œ = å•æ ª Ã— ä¸ªä½“æ•°
   æ˜¾è‘—åº¦ = (èƒ¸é«˜æ–­é¢ç§¯å’Œ) / 600
   ç›¸å¯¹æ˜¾è‘—åº¦(%) = (è¯¥ç§èƒ¸é«˜æ–­é¢ç§¯å’Œ / æ‰€æœ‰ç§èƒ¸é«˜æ–­é¢ç§¯å’Œ) Ã—100%
   é¢‘åº¦(%) = å‡ºç°å°æ ·æ–¹æ•° / 4 Ã—100%
   ç›¸å¯¹é¢‘åº¦(%) = è¯¥ç§é¢‘åº¦ / æ‰€æœ‰ç§é¢‘åº¦ä¹‹å’Œ Ã—100%
   é‡è¦å€¼ = ç›¸å¯¹å¯†åº¦ + ç›¸å¯¹æ˜¾è‘—åº¦ + ç›¸å¯¹é¢‘åº¦
*/
function computeSample(){
  const AREA = 600;
  const PLOTS = 4;
  const rows = Array.from(document.querySelectorAll('#sampleTable tbody tr'));
  // parse species
  const species = [];
  for(const r of rows){
    const inputs = r.querySelectorAll('input');
    const name = inputs[0].value.trim();
    if(!name) continue;
    const n = Number(inputs[1].value) || 0;
    const h = inputs[2].value ? Number(inputs[2].value) : null;
    const dbh = Number(inputs[3].value) || 0; // cm
    const ew = inputs[4].value ? Number(inputs[4].value) : null;
    const ns = inputs[5].value ? Number(inputs[5].value) : null;
    let plots = Number(inputs[6].value) || 0;
    if(plots < 0) plots = 0; if(plots > PLOTS) plots = PLOTS;
    // basal area per individual (m^2)
    const r_m = (dbh/2)/100.0;
    const basal_ind = Math.PI * r_m * r_m;
    const basal_sum = basal_ind * n;
    species.push({name,n,h,dbh,ew,ns,plots,basal_ind,basal_sum});
  }
  if(species.length===0){ alert('è¯·å…ˆè¾“å…¥è‡³å°‘ä¸€ä¸ªç‰©ç§ï¼ˆå¸¦ç§åï¼‰'); return; }

  // totals
  const totalDensity = species.reduce((s,sp)=>s + sp.n / AREA, 0);
  const totalBasalSum = species.reduce((s,sp)=>s + sp.basal_sum, 0);
  const totalFreq = species.reduce((s,sp)=>s + (sp.plots / PLOTS * 100), 0);

  // build result HTML and CSV rows
  let detailHTML = '';
  const csvRows = [];

  // table header
  detailHTML += `<table><thead><tr><th>ç§å</th><th>å¯†åº¦(ä¸ª/mÂ²)</th><th>ç›¸å¯¹å¯†åº¦(%)</th><th>èƒ¸æ–­é¢ç§¯å’Œ(mÂ²)</th><th>ç›¸å¯¹æ˜¾è‘—åº¦(%)</th><th>é¢‘åº¦(%)</th><th>ç›¸å¯¹é¢‘åº¦(%)</th><th>é‡è¦å€¼</th></tr></thead><tbody>`;

  for(const sp of species){
    const density = sp.n / AREA;
    const relDensity = totalDensity > 0 ? (density / totalDensity * 100) : 0;
    const sig = sp.basal_sum / AREA; // æ˜¾è‘—åº¦
    const relSig = totalBasalSum > 0 ? (sp.basal_sum / totalBasalSum * 100) : 0;
    const freq = (sp.plots / PLOTS) * 100;
    const relFreq = totalFreq > 0 ? (freq / totalFreq * 100) : 0;
    const IV = relDensity + relSig + relFreq;

    // table row
    detailHTML += `<tr>
      <td>${sp.name}</td>
      <td>${round2(density).toFixed(4)}</td>
      <td>${fmt(relDensity)}</td>
      <td>${round2(sp.basal_sum).toFixed(4)}</td>
      <td>${fmt(relSig)}</td>
      <td>${fmt(freq)}</td>
      <td>${fmt(relFreq)}</td>
      <td>${fmt(IV)}</td>
    </tr>`;

    // formula block (formula -> ä»£å…¥ -> ç»“æœ)
    detailHTML += `<tr><td colspan="8">
      <div class="formula">
        <strong>${sp.name} è®¡ç®—è¿‡ç¨‹ï¼š</strong><br>
        1) å¯†åº¦ = ${sp.n} / ${AREA} = ${round2(density).toFixed(4)} (ä¸ª/mÂ²)<br>
        2) ç›¸å¯¹å¯†åº¦ = (${round2(density).toFixed(4)} / ${round2(totalDensity).toFixed(4)}) Ã— 100% = ${fmt(relDensity)}%<br>
        3) å•æ ªèƒ¸é«˜æ–­é¢ç§¯ = Ï€ Ã— (DBH/2 /100)^2 = Ï€ Ã— (${sp.dbh}/2 Ã·100)^2 = ${round2(sp.basal_ind).toFixed(4)} mÂ²<br>
        4) èƒ¸é«˜æ–­é¢ç§¯å’Œ = å•æ ª Ã— ä¸ªä½“æ•° = ${round2(sp.basal_ind).toFixed(4)} Ã— ${sp.n} = ${round2(sp.basal_sum).toFixed(4)} mÂ²<br>
        5) æ˜¾è‘—åº¦ = ${round2(sp.basal_sum).toFixed(4)} / ${AREA} = ${round2(sig).toFixed(4)}<br>
        6) ç›¸å¯¹æ˜¾è‘—åº¦ = (${round2(sp.basal_sum).toFixed(4)} / ${round2(totalBasalSum).toFixed(4)}) Ã— 100% = ${fmt(relSig)}%<br>
        7) é¢‘åº¦ = (${sp.plots} / ${PLOTS}) Ã—100% = ${fmt(freq)}%<br>
        8) ç›¸å¯¹é¢‘åº¦ = (${fmt(freq)} / ${fmt(totalFreq)}) Ã— 100% = ${fmt(relFreq)}%<br>
        9) é‡è¦å€¼ = ${fmt(relDensity)} + ${fmt(relSig)} + ${fmt(relFreq)} = ${fmt(IV)}
      </div>
    </td></tr>`;

    // csv row
    csvRows.push(['æ ·æ–¹æ³•', new Date().toLocaleString(), sp.name, fmt(relDensity), fmt(relSig), fmt(relFreq), fmt(IV)]);
  }

  detailHTML += '</tbody></table>';

  // display & record
  document.getElementById('sampleResult').innerHTML = detailHTML;
  appendRecord({method:'æ ·æ–¹æ³•', time: new Date().toLocaleString(), detailHTML, csvRows});
}

/* ---- è®¡ç®—ï¼šä¸­ç‚¹æ–¹è§’æ³• ----
   å…¬å¼ï¼ˆä¸ºæ¯ä¸ªç‰©ç§ï¼‰ï¼š
   ç›¸å¯¹å¯†åº¦(%) = (è¯¥ç§æ€»ä¸ªä½“æ•° / æ‰€æœ‰ç§æ€»ä¸ªä½“æ•°) Ã— 100%
   é¢‘åº¦ = å‡ºç°æ ·ç‚¹æ•° / æ ·ç‚¹æ€»æ•° Ã—100%  ï¼ˆæ˜¾ç¤ºä¸º %ï¼‰
   ç›¸å¯¹é¢‘åº¦(%) = è¯¥ç§é¢‘åº¦ / æ‰€æœ‰ç§é¢‘åº¦ä¹‹å’Œ Ã— 100%
   ç›¸å¯¹æ˜¾è‘—åº¦(%) = è¯¥ç§èƒ¸æ–­é¢ç§¯å’Œ / æ‰€æœ‰ç§èƒ¸æ–­é¢ç§¯å’Œ Ã—100%
   é‡è¦å€¼ = ç›¸å¯¹å¯†åº¦ + ç›¸å¯¹æ˜¾è‘—åº¦ + ç›¸å¯¹é¢‘åº¦
*/
function computePoint(){
  const totalPoints = Number(document.getElementById('pointTotal').value) || 1;
  const rows = Array.from(document.querySelectorAll('#pointTable tbody tr'));
  const species = [];
  for(const r of rows){
    const inputs = r.querySelectorAll('input');
    const name = inputs[0].value.trim();
    if(!name) continue;
    const n = Number(inputs[1].value) || 0;
    const h = inputs[2].value ? Number(inputs[2].value) : null;
    const dbh = Number(inputs[3].value) || 0;
    const ew = inputs[4].value ? Number(inputs[4].value) : null;
    const ns = inputs[5].value ? Number(inputs[5].value) : null;
    const appear = Number(inputs[6].value) || 0;
    const r_m = (dbh/2)/100.0;
    const basal_ind = Math.PI * r_m * r_m;
    const basal_sum = basal_ind * n;
    species.push({name,n,h,dbh,ew,ns,appear,basal_ind,basal_sum});
  }
  if(species.length===0){ alert('è¯·å…ˆè¾“å…¥è‡³å°‘ä¸€ä¸ªç‰©ç§ï¼ˆå¸¦ç§åï¼‰'); return; }

  const totalIndividuals = species.reduce((s,sp)=>s+sp.n,0);
  const totalBasalSum = species.reduce((s,sp)=>s+sp.basal_sum,0);
  const totalFreqPercentSum = species.reduce((s,sp)=>s + (sp.appear / totalPoints * 100), 0);

  // build result
  let detailHTML = '';
  const csvRows = [];
  detailHTML += `<table><thead><tr><th>ç§å</th><th>ç›¸å¯¹å¯†åº¦(%)</th><th>èƒ¸æ–­é¢ç§¯å’Œ(mÂ²)</th><th>ç›¸å¯¹æ˜¾è‘—åº¦(%)</th><th>é¢‘åº¦(%)</th><th>ç›¸å¯¹é¢‘åº¦(%)</th><th>é‡è¦å€¼</th></tr></thead><tbody>`;

  for(const sp of species){
    const relDensity = totalIndividuals>0 ? (sp.n / totalIndividuals * 100) : 0;
    const relSig = totalBasalSum>0 ? (sp.basal_sum / totalBasalSum * 100) : 0;
    const freq = (sp.appear / totalPoints) * 100;
    const relFreq = totalFreqPercentSum>0 ? (freq / totalFreqPercentSum * 100) : 0;
    const IV = relDensity + relSig + relFreq;

    detailHTML += `<tr>
      <td>${sp.name}</td>
      <td>${fmt(relDensity)}</td>
      <td>${round2(sp.basal_sum).toFixed(4)}</td>
      <td>${fmt(relSig)}</td>
      <td>${fmt(freq)}</td>
      <td>${fmt(relFreq)}</td>
      <td>${fmt(IV)}</td>
    </tr>`;

    detailHTML += `<tr><td colspan="7">
      <div class="formula">
        <strong>${sp.name} è®¡ç®—è¿‡ç¨‹ï¼ˆä¸­ç‚¹æ–¹è§’æ³•ï¼‰ï¼š</strong><br>
        1) ç›¸å¯¹å¯†åº¦ = (${sp.n} / ${totalIndividuals}) Ã—100% = ${fmt(relDensity)}%<br>
        2) èƒ¸æ–­é¢ç§¯å’Œ = å•æ ª ${round2(sp.basal_ind).toFixed(4)} Ã— ${sp.n} = ${round2(sp.basal_sum).toFixed(4)} mÂ²<br>
        3) ç›¸å¯¹æ˜¾è‘—åº¦ = (${round2(sp.basal_sum).toFixed(4)} / ${round2(totalBasalSum).toFixed(4)}) Ã—100% = ${fmt(relSig)}%<br>
        4) é¢‘åº¦ = (${sp.appear} / ${totalPoints}) Ã—100% = ${fmt(freq)}%<br>
        5) ç›¸å¯¹é¢‘åº¦ = (${fmt(freq)} / ${fmt(totalFreqPercentSum)}) Ã—100% = ${fmt(relFreq)}%<br>
        6) é‡è¦å€¼ = ${fmt(relDensity)} + ${fmt(relSig)} + ${fmt(relFreq)} = ${fmt(IV)}
      </div>
    </td></tr>`;

    csvRows.push(['ä¸­ç‚¹æ–¹è§’æ³•', new Date().toLocaleString(), sp.name, fmt(relDensity), fmt(relSig), fmt(relFreq), fmt(IV)]);
  }

  detailHTML += '</tbody></table>';
  document.getElementById('pointResult').innerHTML = detailHTML;
  appendRecord({method:'ä¸­ç‚¹æ–¹è§’æ³•', time: new Date().toLocaleString(), detailHTML, csvRows});
}

/* ---- é¡µé¢åˆå§‹åŒ–: é˜²æ­¢è¯¯æ“ä½œ ---- */
document.addEventListener('DOMContentLoaded', ()=>{ renderHistory(); });
</script>
</body>
</html>
